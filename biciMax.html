<html>
<head>
	<title>Bici</title>
	<style>
	body {
		font-family: Monospace;
		background-color: #f0f0f0;
		margin: 0px;
		overflow: hidden;
	}

	canvas {
		width: 100%;
		height: 100%;
	}
	</style>
	<script src="lib/three.min.js"></script>
	<script src="lib/stats.min.js"></script>
	<script src="lib/GLTFLoader.js"></script>
	<script src="lib/OrbitControls.js"></script>
</head>
<body>
	<script>

	function ShaderLoader(vertex_url, fragment_url, onLoad, onProgress, onError) {
		var vertex_loader = new THREE.FileLoader(THREE.DefaultLoadingManager);
		vertex_loader.setResponseType('text');
		vertex_loader.load(vertex_url, function (vertex_text) {
			var fragment_loader = new THREE.FileLoader(THREE.DefaultLoadingManager);
			fragment_loader.setResponseType('text');
			fragment_loader.load(fragment_url, function (fragment_text) {
				onLoad(vertex_text, fragment_text);
			});
		}, onProgress, onError);
	}

	scene = new THREE.Scene();
	camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
	renderer = new THREE.WebGLRenderer( { antialias: true } );
	renderer.setSize( window.innerWidth, window.innerHeight );
	renderer.setClearColor( 0xf0f0f0 );
	document.body.appendChild( renderer.domElement );

	// default: white, 1.0 intensity
	var lightParameters = {

		red: 1.0,
		green: 1.0,
		blue: 1.0,
		intensity: 1.0,
	}

	// Metal
	var materialParameters = {

		cdiff_red: 0.7,
		cdiff_green: 0.7,
		cdiff_blue: 0.6,
		cspec_red: 0.56,
		cspec_green: 0.56,
		cspec_blue: 0.57,
		roughness: 0.8
	}

	var uniforms = {

		cspec:	{ type: "v3", value: new THREE.Vector3() },
		cdiff:	{ type: "v3", value: new THREE.Vector3() },
		roughness: {type: "f", value: 0.5},
		pointLightPosition:	{ type: "v3", value: new THREE.Vector3() },
		pointLightPosition2:	{ type: "v3", value: new THREE.Vector3() },
		clight:	{ type: "v3", value: new THREE.Vector3() },
	};

	stats = new Stats();
	stats.domElement.style.position = 'absolute';
	stats.domElement.style.top = '0px';
	document.body.appendChild( stats.domElement );

	ShaderLoader("lib/Shader/Telaio/vertexTelaio.vert", "lib/Shader/Telaio/fragmentTelaio.frag",
	function (vertexTelaio, fragmentTelaio) {
		materialTelaio = new THREE.ShaderMaterial({uniforms: uniforms,	vertexShader: vertexTelaio,	fragmentShader: fragmentTelaio });

	var lightMesh = new THREE.Mesh( new THREE.SphereGeometry( 1, 16, 16), new THREE.MeshBasicMaterial ({color: 0xffff00, wireframe:true}));
	lightMesh.position.set( 0, 0, 5 );
	uniforms.pointLightPosition.value = new THREE.Vector3(lightMesh.position.x, lightMesh.position.y, lightMesh.position.z);

	var lightMesh2 = new THREE.Mesh( new THREE.SphereGeometry( 1, 16, 16), new THREE.MeshBasicMaterial ({color: 0xffff00, wireframe:true}));
	lightMesh2.position.set( -10, 0, 5 );
	uniforms.pointLightPosition2.value = new THREE.Vector3(lightMesh2.position.x, lightMesh2.position.y, lightMesh2.position.z);

	bici = creaBici(1);
	scene.add(bici, lightMesh, lightMesh2);
	camera.position.z = 10;

	function creaBici(mul)
	{
		//TODO
		var pivotBici = new THREE.Object3D();
		var telaio = creaTelaio(0xff0000,mul);
		var ruotaDietro = creaRuota(3.5,0x000000,mul);
		var ruotaDavanti = creaRuota(3.5,0x000000,mul);
		var manubrio = creaManubrio();
		ruotaDietro.position.set(0,5,8.4);
		ruotaDietro.rotation.set(0,Math.PI*90/180,0);
		ruotaDavanti.position.set(0,5,-5);
		ruotaDavanti.rotation.set(0,Math.PI*90/180,0);
		pivotBici.add(telaio,manubrio,ruotaDietro,ruotaDavanti);
		pivotBici.position.set(0,-30,0);
		pivotBici.rotation.set(0,Math.PI*90/180,0);

		return pivotBici;
	}

	function creaTelaio(colore,mul,image)
	{
		var pivotTelaio = new THREE.Object3D();
		var geometryDietro1 = new THREE.CylinderGeometry( 0.05*mul, 0.05*mul, 5.6*mul, 32 );
		var geometryDietro2 = new THREE.CylinderGeometry( 0.05*mul, 0.05*mul, 4.75*mul, 32 );
		var geometryInMezzo1 = new THREE.CylinderGeometry( 0.2*mul, 0.2*mul, 10*mul, 32 );
		var geometryInMezzo2 = new THREE.CylinderGeometry( 0.2*mul, 0.2*mul, 10.3*mul, 32 );
		var geometryInMezzo3 = new THREE.CylinderGeometry( 0.2*mul, 0.2*mul, 6*mul, 32 );
		var geometryInMezzo4 = new THREE.CylinderGeometry( 0.2*mul, 0.2*mul, 2*mul, 32 );
		var geometryDavanti1 = new THREE.CylinderGeometry( 0.3*mul, 0.2*mul, 2*mul, 32 );
		var geometryDavanti2 = new THREE.CylinderGeometry( 0.05*mul, 0.05*mul, 4*mul, 32 );
		var geometryDavanti3 = new THREE.CylinderGeometry( 0.2*mul, 0.2*mul, 0.5*mul, 32 );

		var cylinder1 = new THREE.Mesh( geometryInMezzo1, materialTelaio );
		var cylinder2 = new THREE.Mesh( geometryInMezzo2, materialTelaio );
		var cylinder3 = new THREE.Mesh( geometryInMezzo3, materialTelaio );
		var cylinder4 = new THREE.Mesh( geometryInMezzo4, materialTelaio );
		var cylinder5 = new THREE.Mesh( geometryDietro1, materialTelaio );
		var cylinder6 = new THREE.Mesh( geometryDietro1, materialTelaio );
		var cylinder7 = new THREE.Mesh( geometryDietro2, materialTelaio );
		var cylinder8 = new THREE.Mesh( geometryDietro2, materialTelaio );
		var cylinder9 = new THREE.Mesh( geometryDavanti1, materialTelaio );
		var cylinder10 = new THREE.Mesh( geometryDavanti3, materialTelaio );
		var cylinder11 = new THREE.Mesh( geometryDavanti2, materialTelaio );
		var cylinder12 = new THREE.Mesh( geometryDavanti2, materialTelaio );
		cylinder1.position.set(0,10*mul,0);
		cylinder1.rotation.set(Math.PI*90/180,0,0);
		cylinder2.position.set(0,7.3*mul,-0.6*mul);
		cylinder2.rotation.set(Math.PI*120/180,0,0);
		cylinder3.position.set(0,7.5*mul,4.5*mul);
		cylinder3.rotation.set(Math.PI*10/180,0,0);
		cylinder4.position.set(0,10.9*mul,5*mul);
		cylinder5.position.set(0.1*mul,7*mul,6.7*mul);
		cylinder5.rotation.set(Math.PI*315/180,0,0);
		cylinder6.position.set(-0.1*mul,7*mul,6.7*mul);
		cylinder6.rotation.set(Math.PI*315/180,0,0);
		cylinder7.position.set(0.1*mul,5*mul,6.4*mul);
		cylinder7.rotation.set(Math.PI*90/180,0,0);
		cylinder8.position.set(-0.1*mul,5*mul,6.4*mul);
		cylinder8.rotation.set(Math.PI*90/180,0,0);
		cylinder9.position.set(0,10*mul,-5*mul);
		cylinder10.position.set(0,9*mul,-5*mul);
		cylinder10.rotation.set(Math.PI*90/180,0,Math.PI*90/180);
		cylinder11.position.set(0.1*mul,7*mul,-5*mul);
		cylinder12.position.set(-0.1*mul,7*mul,-5*mul);
		pivotTelaio.add(cylinder1,cylinder2,cylinder3,cylinder4,cylinder5,cylinder6,
										cylinder7,cylinder8,cylinder9,cylinder10,cylinder11,
										cylinder12);
		return pivotTelaio;
	}

	function creaRuota(ray,colore,mul,image)
	{
		//ray max= 3.5
		//TODO
		var pivotRuota = new THREE.Object3D();
		var geometryGomma = new THREE.TorusGeometry( ray, 0.05, 16, 100 );
		var geometryRaggio = new THREE.CubeGeometry(0.01,0.3,ray);
		var geometryCerchione = new THREE.TorusGeometry( ray-0.05, 0.05, 16, 100 );
		var geometryCerchione1 = new THREE.TorusGeometry( ray-0.10, 0.05, 16, 100 );
		var geometryCerchione2 = new THREE.TorusGeometry( ray-0.15, 0.05, 16, 100 );
		var texture = new THREE.TextureLoader().load( image);
		var materialGomma,materialCerchione,materialRaggio;
		materialCerchione = new THREE.MeshLambertMaterial({color:0xffff00});
		materialRaggio = new THREE.MeshLambertMaterial({color:0x111111});
		if(image==undefined){
				materialGomma = new THREE.MeshLambertMaterial({color:colore});
		}
		else{
			materialGomma = new THREE.MeshLambertMaterial({map:texture});
			materialCerchione = new THREE.MeshLambertMaterial({map:texture});
		}
		var gomma = new THREE.Mesh( geometryGomma, materialGomma );
		var cerchione = new THREE.Mesh(geometryCerchione,materialCerchione);
		var cerchione1 = new THREE.Mesh(geometryCerchione1,materialCerchione);
		var cerchione2 = new THREE.Mesh(geometryCerchione2,materialCerchione);
		var raggio1 = new THREE.Mesh(geometryRaggio,materialRaggio);
		var raggio2 = new THREE.Mesh(geometryRaggio,materialRaggio);
		var raggio3 = new THREE.Mesh(geometryRaggio,materialRaggio);
		var raggio4 = new THREE.Mesh(geometryRaggio,materialRaggio);
		var raggio5 = new THREE.Mesh(geometryRaggio,materialRaggio);
		var pivotRaggio1 = new THREE.Object3D();
		var pivotRaggio2 = new THREE.Object3D();
		var pivotRaggio3 = new THREE.Object3D();
		var pivotRaggio4 = new THREE.Object3D();
		var pivotRaggio5 = new THREE.Object3D();
		raggio1.position.set(0,ray/2,0);
		raggio1.rotation.set(Math.PI*90/180,0,Math.PI*90/180);
		raggio2.position.set(0,ray/2,0);
		raggio2.rotation.set(Math.PI*90/180,0,Math.PI*90/180);
		pivotRaggio2.rotation.set(0,0,Math.PI*72/180);
		raggio3.position.set(0,ray/2,0);
		raggio3.rotation.set(Math.PI*90/180,0,Math.PI*90/180);
		pivotRaggio3.rotation.set(0,0,Math.PI*144/180);
		raggio4.position.set(0,ray/2,0);
		raggio4.rotation.set(Math.PI*90/180,0,Math.PI*90/180);
		pivotRaggio4.rotation.set(0,0,Math.PI*216/180);
		raggio5.position.set(0,ray/2,0);
		raggio5.rotation.set(Math.PI*90/180,0,Math.PI*90/180);
		pivotRaggio5.rotation.set(0,0,Math.PI*288/180);
		pivotRaggio2.add(raggio2);
		pivotRaggio3.add(raggio3);
		pivotRaggio4.add(raggio4);
		pivotRaggio5.add(raggio5);
		pivotRuota.add( gomma,cerchione,cerchione1,cerchione2,raggio1,pivotRaggio2,pivotRaggio3,pivotRaggio4,pivotRaggio5 );
		return pivotRuota;
	}

		function creaManubrio()
		{
			var pivotManubrio = new THREE.Object3D();
			var Dx = new THREE.CylinderGeometry( 0.2, 0.2, 1, 32 );
			var Sx = new THREE.CylinderGeometry( 0.2, 0.2, 1, 32 );
			var Centro = new THREE.CylinderGeometry( 0.1, 0.1, 4, 32 );
			var sotto = new THREE.CylinderGeometry( 0.2, 0.3, 1, 32 );

			var manubrioCentrale = new THREE.Mesh( Centro, materialTelaio );
			var manubrioLatoDx = new THREE.Mesh( Dx, materialTelaio  );
			var manubrioLatoSx = new THREE.Mesh( Sx, materialTelaio  );
			var manubrioSotto = new THREE.Mesh( sotto, materialTelaio  );

			manubrioLatoDx.position.set(2,0,0);
			manubrioLatoSx.position.set(-2,0,0);
			manubrioSotto.position.set(0, -0.5, 0);
			manubrioCentrale.rotation.set(0,0,Math.PI*90/180);
			manubrioLatoDx.rotation.set(0,0,Math.PI*90/180);
			manubrioLatoSx.rotation.set(0,0,Math.PI*90/180);

			pivotManubrio.add(manubrioCentrale, manubrioLatoDx, manubrioLatoSx, manubrioSotto);
			pivotManubrio.position.set(0,12,-5);
			return pivotManubrio;
		}

		function creaPedali()
		{
			//TODO
		}

		function creaCatena()
		{
			//TODO
		}

		function creaFanale()
		{
			//TODO
		}

		function creaSellino()
		{
			//TODO
		}

		function creaBorraccia()
		{

		}

		function init() {

			renderer.gammaInput = true;
			renderer.gammaOutput = true;
			renderer.setClearColor( 0xf0f0f0 );

			document.body.appendChild( renderer.domElement );
			renderer.setPixelRatio( window.devicePixelRatio );
			renderer.setSize( window.innerWidth, window.innerHeight );

			controls = new THREE.OrbitControls(camera);
			controls.addEventListener( 'change', render );
			controls.addEventListener( 'change', render );
			controls.minDistance = 1;
			controls.maxDistance = 100;
			//controls.maxPolarAngle = Math.PI / 2;
			controls.enablePan = false;
			controls.target.copy( bici.position );
			controls.update();

			window.addEventListener( 'resize', onResize, false );

			stats.domElement.style.position = 'absolute';
			stats.domElement.style.top = '0px';
			document.body.appendChild( stats.domElement );
		}

		function onResize() {

			renderer.setSize( window.innerWidth, window.innerHeight );
			camera.aspect = ( window.innerWidth / window.innerHeight );
			camera.updateProjectionMatrix();
		}

		function update() {
			requestAnimationFrame( update );
			stats.update();
			render();
		}

		var render = function () {
			updateUniforms();
			renderer.render( scene, camera );
		};

		function updateUniforms() {

			uniforms.cspec.value = new THREE.Vector3(materialParameters.cspec_red, materialParameters.cspec_green,materialParameters.cspec_blue);
			uniforms.cdiff.value = new THREE.Vector3(materialParameters.cdiff_red, materialParameters.cdiff_green,materialParameters.cdiff_blue);
			uniforms.roughness.value = materialParameters.roughness>0.0?materialParameters.roughness:0.01;
			uniforms.clight.value = new THREE.Vector3( lightParameters.red * lightParameters.intensity, lightParameters.green * lightParameters.intensity,
				lightParameters.blue * lightParameters.intensity);
		}

	  init();
		update();
	  render();
		});

		</script>
	</body>
</html>
